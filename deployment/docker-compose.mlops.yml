services:
  mlflow:
    build: ./mlops/mlflow
    depends_on:
      - db
    ports:
      - "${MLFLOW_PORT:-5000}:5000"
    environment:
      MLFLOW_BACKEND_STORE_URI: "${MLFLOW_BACKEND_STORE_URI}"
      MLFLOW_DEFAULT_ARTIFACT_ROOT: "${MLFLOW_DEFAULT_ARTIFACT_ROOT:-/mlflow/artifacts}"
    volumes:
      - ./mlops/mlflow/artifacts:/mlflow/artifacts

  airflow:
    build:
      context: ./mlops
      dockerfile: airflow/Dockerfile
    ports:
      - "${AIRFLOW_PORT:-8080}:8080"
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__EXECUTOR: "SequentialExecutor"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: "sqlite:////opt/airflow/airflow.db"
      MLFLOW_TRACKING_URI: "${MLFLOW_TRACKING_URI:-http://mlflow:5000}"
      PROJECT_ROOT: "/opt/project"
      PYTHONPATH: "/opt/project/deployment"
    volumes:
      - ./mlops/airflow/dags:/opt/airflow/dags
      - ./:/opt/project
    depends_on:
      - mlflow
    command: >
      bash -c "airflow db migrate && \
               airflow users create --username ${AIRFLOW_ADMIN_USER:-admin} --password ${AIRFLOW_ADMIN_PASSWORD:-admin} --firstname Admin --lastname User --role Admin --email ${AIRFLOW_ADMIN_EMAIL:-admin@example.com} || true && \
               airflow webserver & airflow scheduler"

  post_hoc_backfill:
    build:
      context: ./mlops
      dockerfile: airflow/Dockerfile
    profiles: ["manual"]
    environment:
      MLFLOW_TRACKING_URI: "${MLFLOW_TRACKING_URI:-http://mlflow:5000}"
      PYTHONPATH: "/opt/project/deployment"
    volumes:
      - ./:/opt/project
    depends_on:
      - mlflow
    command: >
      bash -c "python /opt/project/deployment/mlops/jobs/post_hoc_backfill.py --register-model"
